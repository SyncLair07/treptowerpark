<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map - Treptower Park Archive</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <nav class="navbar" style="border-bottom: none; border-right: 2px solid black;">
         <div style="display:flex; align-items:center;">
            <a href="index.html" class="site-title" style="border-right: 2px solid black; padding-right: 20px; margin-right: 20px;">Treptowerpark Archive</a>
            <a href="info.html" style="margin-right: 20px; color:black; text-decoration:none; font-weight:bold;">About</a>
            <a href="archive.html" style="color:black; text-decoration:none; font-weight:bold;">Archive</a>
        </div>
        <div class="nav-links">
            <button style="padding: 5px 15px; background:white; border: 2px solid black; font-weight:bold; margin-right:10px;">Upload</button>
            <button style="padding: 5px 15px; background:white; border: 2px solid black; font-weight:bold;">Profile</button>
        </div>
    </nav>

    <div class="map-layout-wrapper">
        
        <aside class="sidebar" id="sidebar">
            
            <div class="sidebar-section">
                <strong>Filter</strong><br>
                <input type="checkbox" id="filter1" name="filter1" checked>
                <label for="filter1"> Exhibition Spots</label><br>
                <input type="checkbox" id="filter2" name="filter2" checked>
                 <label for="filter2"> Landmarks / Kairo</label>
            </div>

            <div class="sidebar-section">
                <input type="text" id="searchInput" placeholder="Search by Keywords..." style="width: 100%; padding: 5px;">
            </div>

            <div class="sidebar-section">
                <button onclick="locateUser()" style="width:100%; background: #a7c7e7; border: 1px solid black; padding: 5px 10px; cursor: pointer; font-weight:bold;">
                    üìç Find My Location
                </button>
            </div>

            <div class="sidebar-section" style="flex:1;">
                <strong>Result List</strong><br>
                <p style="font-size:0.8rem; color:grey;">(Filters apply automatically)</p>
            </div>
        </aside>

        <main class="map-details-container">
            <div id="map"></div>
            
            <section class="details-box" id="detailsBox" style="display:none;">
                <h3 id="detailTitle">Detailed Info</h3>
                <p id="detailDesc">Select a marker on the map to see details.</p>
            </section>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // --- 1. Initialize Map ---
        var map = L.map('map').setView([52.4875, 13.4677], 15);
        
        // Load the Map Tiles (OpenStreetMap)
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // Layer Group for Markers (allows us to clear them later for filtering)
        var markersLayer = L.layerGroup().addTo(map);
        var allLocations = []; // Store data here

        // --- 2. Fetch Data from JSON ---
        fetch('locations.json')
            .then(response => response.json())
            .then(data => {
                allLocations = data; // Save data
                renderMarkers(allLocations); // Show all initially
            })
            .catch(error => console.error('Error loading map data:', error));

        // --- 3. Render Markers Function ---
        function renderMarkers(data) {
            markersLayer.clearLayers(); // Clear existing markers
            
            data.forEach(spot => {
                var marker = L.marker([spot.lat, spot.lng]);
                
                // Popup
                marker.bindPopup(`<b>${spot.name}</b>`);
                
                // Click Event to update bottom box
                marker.on('click', function() {
                    updateDetailBox(spot);
                });

                markersLayer.addLayer(marker);
            });
        }

        // --- 4. Update Detail Box Function ---
        function updateDetailBox(spot) {
            var box = document.getElementById('detailsBox');
            box.style.display = 'block'; // Make sure it's visible
            box.innerHTML = `
                <div style="text-align:left;">
                    <h3>${spot.name}</h3>
                    <p>${spot.description}</p>
                    ${spot.img ? `<img src="${spot.img}" style="height:100px; margin-top:5px;">` : ''}
                    <br>
                    <a href="${spot.link || '#'}" style="color:blue;">View in Archive &rarr;</a>
                </div>
            `;
        }

        // --- 5. Filter Logic ---
        const searchInput = document.getElementById('searchInput');
        const check1 = document.getElementById('filter1');
        const check2 = document.getElementById('filter2');

        function filterData() {
            const term = searchInput.value.toLowerCase();
            const showExhibition = check1.checked;
            const showLandmarks = check2.checked;

            const filtered = allLocations.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(term);
                // Simple logic: if 'exhibition' checked, show items with category 'exhibition', etc.
                // Note: Ensure your JSON has "category": "exhibition" or "landmark"
                let matchesCategory = false;
                if (showExhibition && item.category === 'exhibition') matchesCategory = true;
                if (showLandmarks && (item.category === 'landmark' || item.category === 'doors')) matchesCategory = true;

                return matchesSearch && matchesCategory;
            });

            renderMarkers(filtered);
        }

        // Add Event Listeners
        searchInput.addEventListener('input', filterData);
        check1.addEventListener('change', filterData);
        check2.addEventListener('change', filterData);


        // --- 6. Geolocation Logic ---
        function locateUser() {
            map.locate({setView: true, maxZoom: 16});
        }

        function onLocationFound(e) {
            var radius = e.accuracy;
            L.circleMarker(e.latlng, {
                radius: 8,
                fillColor: "#3388ff",
                color: "#fff",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map).bindPopup("You are here").openPopup();
            L.circle(e.latlng, radius).addTo(map);
        }

        function onLocationError(e) {
            alert("Error finding location: " + e.message);
        }

        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);

    </script>
</body>
</html>